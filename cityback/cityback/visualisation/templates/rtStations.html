<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Display a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <link href="static/styles/style.css" rel="stylesheet"/>
</head>
<body>

<div id='map'></div>
<button type="button" onclick="runButton()">Debug Mode</button>
The debug mode is <span id="dbg">false</span>.
<script type="text/javascript">

    // create mapbox object
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNlcHJvamVjdGdyb3VwMTEiLCJhIjoiY2pkdWE2dHRuMTVmODMzbGxzY3htNzVmZCJ9.rp6HgWPAmVtqsQ9pOR4PdA';
    let map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/aseprojectgroup11/cjdyqc4ce377n2sqij5ark9hb', // stylesheet location
        center: [-6.264, 53.346], // starting position [lng, lat]
        zoom: 13.25, // starting zoom
    });
    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // dict to store stations previous occupancy
    var previousOccuapancy = [];
    var mapLoaded = false;
    var firstJson = undefined;
    map.on('load', function(){
        {#var geojson = {{ stations|safe }};#}
        var empty = {type: 'FeatureCollection', features: []}
        map.addSource('bikesource', {type: 'geojson', data: empty});
        map.addLayer({
            "id": "bikes",
            "type": "circle",
            "source": "bikesource",
            "paint": {
                'circle-color':
                    {property: 'occupancy',
                        type: 'exponential',
                        stops: [[0, '#ffffff'],
                            [1, '#ccddff'],
                            [99, '#006bc0'],
                            [100, '#777777']]},
                'circle-radius': {
                    property: 'vacancy',
                    type: 'exponential',
                    stops: [[0, 15],
                        [100, 15]]},
                'circle-opacity': 1.0,
                "circle-stroke-width": {
                    property: 'occupancyChanged',
                    type: 'exponential',
                    stops: [
                        [0, 2],
                        [1, 3]
                    ]
                },
                "circle-stroke-color": {
                    property: 'occupancyChanged',
                    type: 'exponential',
                    stops: [
                        [0, '#000000'],
                        [1, '#D00000']
                    ]
                },
            }
        });
        mapLoaded = true;
        if(firstJson != undefined){
            updateMap(firstJson)
        }
    });

    function onOpen(evt) {
        console.log("Connected to websocket!");
        websocket.send(JSON.stringify({data: "Hello"}));
    }

    var num = 99;
    var debug = false;
    {#var occupancy = -1;#}
    {#var vacancy = -1;#}
    function updateMap(geoStation){
        geoFeatures = geoStation['features'];
        {#console.log(geoFeatures);#}
        for (var i = 0; i < geoFeatures.length; i++) {
            var geoProperty = geoFeatures[i]['properties'];
            if(i in previousOccuapancy &&
                geoProperty['occupancy'] == previousOccuapancy[i]){
                geoProperty['occupancyChanged'] = 0;
            }else{
                geoProperty['occupancyChanged'] = 1;
                previousOccuapancy[i] = geoProperty['occupancy']
            }
        }
        map.getSource('bikesource').setData(geoStation);
    }

    function onMessage(evt) {
        console.log("data_received");
        var svals = JSON.parse(evt.data).stations;
        if(!mapLoaded){
            firstJson = svals;
        }else{
            updateMap(svals)
        }
    }

    function setupWebSocket() {
        if (window.location.protocol != "https:") {
            prefix = "ws";
        }else{
            prefix = "wss";
        }
        websocket = new WebSocket(prefix + "://"  + location.host + "/ws/rtStations");
        websocket.onopen = function(evt) { onOpen(evt); };
        websocket.onmessage = function(evt) { onMessage(evt); };
    }

    function runButton() {
        debug = !debug;
        document.getElementById("dbg").innerHTML = debug;
    }
    window.addEventListener("load", setupWebSocket);

</script>
</body>
</html>
</html>