<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Display a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <link href="static/styles/style.css" rel="stylesheet"/>
</head>
<body>

<div id='map'></div>
<button type="button" onclick="runButton()">Debug Mode</button>
The debug mode is <span id="dbg">false</span>.
<div>Icons made by <a href="https://www.flaticon.com/authors/nikita-golubev" title="Nikita Golubev">Nikita Golubev</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
<script type="text/javascript">

    // create mapbox object
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNlcHJvamVjdGdyb3VwMTEiLCJhIjoiY2pkdWE2dHRuMTVmODMzbGxzY3htNzVmZCJ9.rp6HgWPAmVtqsQ9pOR4PdA';
    let map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/aseprojectgroup11/cjdyqc4ce377n2sqij5ark9hb', // stylesheet location
        center: [-6.264, 53.346], // starting position [lng, lat]
        zoom: 13.25, // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', function() {

        var geojson = {{ stations|safe }};

        map.addSource('bikesource', {type: 'geojson', data: geojson});
        map.addLayer({
            "id": "bikes",
            "type": "circle",
            "source": "bikesource",
            "paint": {
                'circle-color': {
                    property: 'occupancy',
                    type: 'exponential',
                    stops: [
                        [0, '#ccddff'],
                        [100, '#002b80']
                    ]
                },
                'circle-radius': {
                    property: 'vacancy',
                    type: 'exponential',
                    stops: [
                        [0, 5],
                        [100, 15]
                    ]
                },
                'circle-opacity': 0.8,
                "circle-stroke-width": [
                    'match',
                    ['get', 'occupancyChanged'],
                    1, 3,
                    /* other */ 1
                ],
                "circle-stroke-color": '#000'
            }
        });
    });

    function onOpen(evt) {
        console.log("Connected to websocket!");
        websocket.send(JSON.stringify({data: "Hello"}));
    }

    var num = 99;
    var debug = false;
    var occupancy = -1;
    var vacancy = -1;
    function onMessage(evt) {

        console.log("data_received")
        svals = JSON.parse(evt.data).stations;
        var updated = "";

        map.getSource('bikesource').setData(svals);

        {% comment %}var svalsProp = svals['features'];
        svalsProp.forEach(function(station) {

            console.log(station);
        });{% endcomment %}

        {% comment %}svals.forEach(function(station) {
            // create a HTML element for each feature

            var el = document.getElementById(station.station_number);
            var percent_available_bikes = station.available_bikes * 100 / station.bike_stands;
            if (percent_available_bikes == 0) {

                el.style.backgroundColor = 'red';
            }
            else if (percent_available_bikes <= 33) {

                el.style.backgroundColor = 'orange';
            }
            else if (percent_available_bikes <= 67) {

                el.style.backgroundColor = 'yellow';
            }
            else {

                el.style.backgroundColor = 'green';
            }

            if(debug && station.station_number == 21){
                el.textContent = ("S" + station.station_number +
                    ",B:" + num + ", S:" +
                    station.available_bike_stands);
                el.className = "markerbicycle";
                num++;
            }else {
                el.textContent = ("S" + station.station_number +
                    ",B:" + station.available_bikes + ", S:" +
                    station.available_bike_stands);
                updated += station.station_number + " ";
            }
        });{% endcomment %}
        {#document.getElementById("rand").innerHTML = updated;#}

    }

    function setupWebSocket() {
        if (window.location.protocol != "https:") {
            prefix = "ws";
        }else{
            prefix = "wss";
        }
        websocket = new WebSocket(prefix + "://"  + location.host + "/ws/rtStations");
        websocket.onopen = function(evt) { onOpen(evt); };
        websocket.onmessage = function(evt) { onMessage(evt); };
    }

    function runButton() {
        debug = !debug;
        document.getElementById("dbg").innerHTML = debug;
    }
    window.addEventListener("load", setupWebSocket);

</script>
</body>
</html>